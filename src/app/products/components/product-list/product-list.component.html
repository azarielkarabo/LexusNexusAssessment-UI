<div class="card-spacer">
  <mat-card [class.mat-elevation-z1]="'true'">
    
    <!-- Search and Filter Section -->
    <div class="search-container">
      <form [formGroup]="searchForm" class="search-form">
        
        <!-- Basic Search Row -->
        <div class="search-row basic-search">
          <mat-form-field appearance="outline" class="search-field">
            <mat-label>Search products...</mat-label>
            <input matInput formControlName="searchTerm" placeholder="Name, SKU, Description">
            <mat-icon matSuffix>search</mat-icon>
          </mat-form-field>

          <mat-form-field appearance="outline" class="category-field">
            <mat-label>Category</mat-label>
            <mat-select formControlName="categoryId">
              <mat-option [value]="null">All Categories</mat-option>
              <mat-option *ngFor="let category of categories" [value]="category.id">
                {{category.name}}
              </mat-option>
            </mat-select>
          </mat-form-field>

          <button type="button" mat-icon-button class="advanced-toggle" 
                  (click)="toggleAdvancedSearch()" 
                  [class.active]="showAdvancedSearch"
                  matTooltip="Advanced Search">
            <mat-icon>{{showAdvancedSearch ? 'expand_less' : 'expand_more'}}</mat-icon>
          </button>

          <button type="button" mat-icon-button color="warn" 
                  (click)="clearSearch()" 
                  matTooltip="Clear Search">
            <mat-icon>clear</mat-icon>
          </button>
        </div>

        <!-- Advanced Search Section -->
        <div class="advanced-search" *ngIf="showAdvancedSearch">
          <div class="search-row">
            <mat-form-field appearance="outline">
              <mat-label>Sort By</mat-label>
              <mat-select formControlName="sortBy">
                <mat-option *ngFor="let option of sortOptions" [value]="option.value">
                  {{option.label}}
                </mat-option>
              </mat-select>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Sort Direction</mat-label>
              <mat-select formControlName="sortDirection">
                <mat-option value="asc">Ascending</mat-option>
                <mat-option value="desc">Descending</mat-option>
              </mat-select>
            </mat-form-field>
          </div>

          <div class="search-row">
            <mat-form-field appearance="outline">
              <mat-label>Min Price</mat-label>
              <input matInput type="number" formControlName="minPrice" placeholder="0.00">
              <span matPrefix>$</span>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Max Price</mat-label>
              <input matInput type="number" formControlName="maxPrice" placeholder="999.99">
              <span matPrefix>$</span>
            </mat-form-field>
          </div>
        </div>
      </form>
    </div>

    <!-- Add Product Button -->
    <div class="card-header">
      <div class="results-info" *ngIf="pagedProducts">
        <span>Showing {{pagedProducts.totalCount}} results</span>
      </div>
      <button mat-raised-button color="primary" (click)="openAddDialog()">
        <mat-icon>add</mat-icon> Add Product
      </button>
    </div>

    <!-- Loading Indicator -->
    <div *ngIf="isLoading" class="loading-container">
      <mat-spinner diameter="40"></mat-spinner>
      <span>Loading products...</span>
    </div>

    <!-- Table -->
    <mat-table [dataSource]="dataSource" class="mat-elevation-z8" matSort *ngIf="!isLoading">
      <!-- Name Column -->
      <ng-container matColumnDef="name">
        <mat-header-cell *matHeaderCellDef mat-sort-header> Name </mat-header-cell>
        <mat-cell *matCellDef="let element"> 
          <span class="cell-content" [title]="element.name">{{element.name}}</span>
        </mat-cell>
      </ng-container>

      <!-- Description Column -->
      <ng-container matColumnDef="description">
        <mat-header-cell *matHeaderCellDef mat-sort-header> Description </mat-header-cell>
        <mat-cell *matCellDef="let element"> 
          <span class="cell-content description" [title]="element.description">
            {{element.description}}
          </span>
        </mat-cell>
      </ng-container>

      <!-- SKU Column -->
      <ng-container matColumnDef="sku">
        <mat-header-cell *matHeaderCellDef mat-sort-header> SKU </mat-header-cell>
        <mat-cell *matCellDef="let element"> 
          <span class="sku-badge">{{element.sku}}</span>
        </mat-cell>
      </ng-container>

      <!-- Price Column -->
      <ng-container matColumnDef="price">
        <mat-header-cell *matHeaderCellDef mat-sort-header> Price </mat-header-cell>
        <mat-cell *matCellDef="let element"> 
          <span class="price">{{element.price | currency}}</span>
        </mat-cell>
      </ng-container>

      <!-- Quantity Column -->
      <ng-container matColumnDef="quantity">
        <mat-header-cell *matHeaderCellDef mat-sort-header> Quantity </mat-header-cell>
        <mat-cell *matCellDef="let element"> 
          <span class="quantity" [class.low-stock]="element.quantity < 10">
            {{element.quantity}}
          </span>
        </mat-cell>
      </ng-container>

      <!-- Category Column -->
      <ng-container matColumnDef="categoryId">
        <mat-header-cell *matHeaderCellDef mat-sort-header> Category </mat-header-cell>
        <mat-cell *matCellDef="let element"> 
          <span class="category-badge">
            {{getCategoryName(element.categoryId) || 'N/A'}}
          </span>
        </mat-cell>
      </ng-container>

      <!-- CreatedAt Column -->
      <ng-container matColumnDef="createdAt">
        <mat-header-cell *matHeaderCellDef mat-sort-header> Created At </mat-header-cell>
        <mat-cell *matCellDef="let element"> 
          <span class="date">{{element.createdAt | date:'short'}}</span>
        </mat-cell>
      </ng-container>

      <!-- Actions Column -->
      <ng-container matColumnDef="actions">
        <mat-header-cell *matHeaderCellDef> Actions </mat-header-cell>
        <mat-cell *matCellDef="let element" class="actions-cell">
          <button mat-icon-button color="primary" (click)="openEditDialog(element)" matTooltip="Edit">
            <mat-icon>edit</mat-icon>
          </button>
          <button mat-icon-button color="warn" (click)="delete(element)" matTooltip="Delete">
            <mat-icon>delete</mat-icon>
          </button>
        </mat-cell>
      </ng-container>

      <!-- Header & Row -->
      <mat-header-row *matHeaderRowDef="displayedColumns"></mat-header-row>
      <mat-row *matRowDef="let row; columns: displayedColumns;" 
               [class.selected-row]="row.selected"></mat-row>
    </mat-table>

    <!-- Empty State -->
    <div *ngIf="!isLoading && (!products || products.length === 0)" class="empty-state">
      <mat-icon class="empty-icon">inventory_2</mat-icon>
      <h3>No products found</h3>
      <p>Try adjusting your search criteria or add a new product.</p>
      <button mat-raised-button color="primary" (click)="openAddDialog()">
        <mat-icon>add</mat-icon> Add First Product
      </button>
    </div>

    <!-- Paginator -->
    <div class="card-spacer" *ngIf="!isLoading && products && products.length > 0">
      <mat-paginator 
        [length]="pagedProducts?.totalCount" 
        (page)="onPageChange($event)" 
        [pageSizeOptions]="options"
        showFirstLastButtons>
      </mat-paginator>
    </div>
  </mat-card>
</div>